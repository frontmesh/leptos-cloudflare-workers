# Leptos Cloudflare Implementation

A full-stack web application built with [Leptos](https://leptos.dev/) and deployed on [Cloudflare Workers](https://workers.cloudflare.com/), showcasing server-side rendering (SSR) and client-side hydration capabilities.

## Overview

This project demonstrates a modern approach to building isomorphic web applications using Rust and Leptos, with seamless deployment to Cloudflare Workers. The application uses:

- **Leptos 0.8**: A full-stack web framework with a reactive UI component model
- **Axum**: A lightweight, modular web framework for server-side routing
- **Cloudflare Workers**: Serverless compute platform for deployment
- **WASM**: WebAssembly for client-side interactivity

## Project Structure

```
leptos-cloudflare-workers/
├── src/
│   ├── app.rs              # Main app component with routing setup
│   ├── lib.rs              # Library root with SSR configuration
│   ├── main.rs             # Binary entrypoint
│   ├── worker_helpers.rs   # Cloudflare Workers integration helpers
│   └── pages/
│       ├── mod.rs          # Page module exports
│       └── home_page.rs    # Home page component
├── style/
│   └── main.css            # Global stylesheet
├── Cargo.toml              # Rust dependencies and build configuration
├── wrangler.toml           # Cloudflare Workers configuration
└── README.md               # This file
```

## Getting Started

### Prerequisites

- Rust 1.70+
- [cargo-leptos](https://github.com/leptos-rs/cargo-leptos) for building
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/install-and-update/) for Cloudflare deployment

### Installation

1. Install dependencies:
```bash
cargo install --locked cargo-leptos
cargo install wrangler
```

2. Clone or navigate to the project directory:
```bash
cd leptos-cf-newest
```

3. Build the project:
```bash
cargo leptos build --release
```

4. Deploy to Cloudflare Workers:
```bash
wrangler deploy
```

## Development

### Local Development

Run the development server with auto-reload:

```bash
cargo leptos watch
```

This will start a development server at `http://127.0.0.1:8787`.

### Build Features

The project uses Cargo features to control compilation:

- **`ssr`**: Server-side rendering for the backend (Axum/Cloudflare Workers)
- **`hydrate`**: Client-side hydration for the WASM bundle

These are automatically configured in `Cargo.toml` metadata for `cargo-leptos`.

### Build Optimization

The release profile is optimized for WASM size:

```toml
[profile.release]
opt-level = "s"    # Optimize for size
lto = true         # Enable Link Time Optimization
strip = true       # Strip symbols
codegen-units = 1  # Single codegen unit for better optimization
```

## Architecture

### Server-Side (SSR)

- **Framework**: Axum with Leptos integration
- **Environment**: Cloudflare Workers (via `worker` crate)
- **Rendering**: Server generates initial HTML with `leptos_axum`

### Client-Side (Hydration)

- **Framework**: Leptos with WASM
- **Output**: JavaScript + WebAssembly bundle
- **Features**: Interactive components with reactive state management

### Routing

Routes are defined in `app.rs:39` using `leptos_router`:

- `/` → `HomePage` component

## Key Dependencies

| Crate | Version | Purpose |
|-------|---------|---------|
| `leptos` | 0.8 | Full-stack reactive framework |
| `leptos_router` | 0.8 | Client and server-side routing |
| `leptos_axum` | 0.8 | Axum integration for Leptos |
| `axum` | 0.8 | Web server framework |
| `worker` | 0.6 | Cloudflare Workers SDK |
| `wasm-bindgen` | 0.2 | JavaScript FFI bindings |
| `serde` / `serde_json` | 1.0 | Serialization framework |

## Deployment

### Cloudflare Workers

This project is configured to deploy to Cloudflare Workers. The build process:

1. Compiles the Leptos project with `cargo leptos build --release`
2. Uses `worker-build` to generate a Cloudflare Workers-compatible bundle
3. Deploys via Wrangler CLI

**Configuration** (`wrangler.toml`):
- Compatibility date: 2025-10-27
- Main handler: `build/index.js`
- Assets directory: `target/site` (generated by cargo-leptos)

### Deploy Command

```bash
wrangler deploy
```

## Configuration

### Leptos Metadata

In `Cargo.toml`, the `[package.metadata.leptos]` section configures:

- **`output-name`**: WASM bundle name (`leptos-cf`)
- **`site-root`**: Output directory (`target/site`)
- **`site-pkg-dir`**: Package directory for JS/WASM (`pkg`)
- **`style-file`**: CSS source file (`style/main.css`)
- **`site-addr`**: Development server address (`127.0.0.1:8787`)

## Styling

Global styles are defined in `style/main.css` and are:
- Processed by Lightning CSS for optimization
- Automatically included in the HTML output
- Available to all components

## Next Steps

To expand this project:

1. **Add more pages**: Create new components in `src/pages/`
2. **Add API endpoints**: Create server functions with `#[server]` macro
3. **Database integration**: Add `worker:d1` features for Cloudflare D1 database
4. **Advanced routing**: Expand routes in `app.rs` with dynamic segments
5. **State management**: Use Leptos signals for reactive state

## Troubleshooting

### Build Issues

- **WASM validation errors**: Set `wasm-validation = false` in `Cargo.toml` (already done)
- **Size optimization**: Release profile optimizes for size; build in release mode for production

### Deployment Issues

- **Wrangler not found**: Install with `npm install -g wrangler` or `cargo install wrangler`
- **Missing Cloudflare config**: Ensure `wrangler.toml` is in project root

## Resources

- [Leptos Documentation](https://leptos.dev/)
- [Cloudflare Workers](https://workers.cloudflare.com/)
- [cargo-leptos](https://github.com/leptos-rs/cargo-leptos)
- [Axum Web Framework](https://github.com/tokio-rs/axum)

## License

This project is provided as-is for educational and development purposes.
